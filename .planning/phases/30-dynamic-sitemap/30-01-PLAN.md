---
phase: 30-dynamic-sitemap
plan: 01
type: execute
domain: seo
---

<objective>
Enhance sitemap with complete URL coverage and scalable architecture.

Purpose: Ensure all indexable pages are in sitemap for SEO discovery, with architecture ready to scale beyond 50,000 URLs using Next.js generateSitemaps pattern.
Output: Enhanced sitemap.ts with deal pages, category-state combinations, improved lastModified dates, and sitemap index preparation.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context:
@.planning/phases/24-seo-foundation/24-02-SUMMARY.md
@.planning/phases/29-service-category-pages/29-01-SUMMARY.md

# Current implementation:
@src/app/sitemap.ts
@src/app/robots.ts
@src/lib/mock-data/deals.ts

**Discovery (Level 1 - Quick Verification):**
- Confirmed Next.js `generateSitemaps()` pattern for sitemap index files (>50k URLs)
- Current sitemap has 40 URLs, well under limit
- Missing: deal detail pages, category-state combinations
- `lastModified` currently uses `new Date()` everywhere (inaccurate)

**Tech stack available:**
- Next.js MetadataRoute.Sitemap type
- Existing mock-data helpers pattern

**Constraining decisions:**
- [Phase 24-02]: Sitemap includes all location hierarchy URLs
- [Phase 29-01]: Category pages at /treatments/[category]
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deal helper and deal pages to sitemap</name>
  <files>src/lib/mock-data/deals.ts, src/app/sitemap.ts</files>
  <action>
    1. In deals.ts, add getAllDealIds() helper that returns array of deal IDs for SSG/sitemap
    2. In sitemap.ts, import getAllDealIds and add deal detail pages at /deals/[id] with priority 0.6
    3. Use actual deal.updatedAt for lastModified instead of new Date()
  </action>
  <verify>npm run build succeeds; curl localhost:3000/sitemap.xml | grep -c "/deals/" shows deal count</verify>
  <done>Sitemap includes all deal detail page URLs with accurate lastModified dates</done>
</task>

<task type="auto">
  <name>Task 2: Add category-state combination URLs</name>
  <files>src/lib/mock-data/categories.ts, src/app/sitemap.ts</files>
  <action>
    1. In categories.ts, add getCategoryStateComboSlugs() that returns array of {categorySlug, stateSlug} combinations
    2. In sitemap.ts, import and add category-state URLs at /treatments/[category]/[state] with priority 0.65
    3. These are future routes for "Botox in California" style landing pages - sitemap preparation

    Note: The actual /treatments/[category]/[state] pages don't exist yet (Phase 31+), but adding to sitemap prepares SEO foundation.
  </action>
  <verify>npm run build succeeds; sitemap includes /treatments/botox/california style URLs</verify>
  <done>Sitemap includes category-state combination URLs for all 6 categories Ã— 4 states (24 URLs)</done>
</task>

<task type="auto">
  <name>Task 3: Refactor for sitemap index architecture</name>
  <files>src/app/sitemap.ts</files>
  <action>
    1. Refactor sitemap.ts into organized sections with clear URL counts per section
    2. Add SITEMAP_CONFIG constant with URL_LIMIT = 50000 and current section sizes
    3. Add comment documenting when to switch to generateSitemaps() (when total > 45000)
    4. Ensure consistent lastModified handling - use content timestamps where available, fallback to config date for static

    Structure:
    - Static pages (home, /deals listing)
    - Location hierarchy (states, cities, neighborhoods)
    - Provider pages
    - Category pages
    - Deal pages
    - Category-state combos

    Do NOT implement generateSitemaps yet - current scale (40+ URLs) doesn't warrant the complexity. Just document the migration path.
  </action>
  <verify>npm run build succeeds; sitemap.xml returns valid XML; URL count matches expected total</verify>
  <done>Sitemap organized with clear sections, URL counts tracked, and migration path documented for future scaling</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `npm run build` succeeds without errors
- [ ] curl http://localhost:3000/sitemap.xml returns valid XML
- [ ] Sitemap includes /deals/deal-1, /deals/deal-2, etc. URLs
- [ ] Sitemap includes /treatments/botox/california style URLs
- [ ] Total URL count is documented in code comments
- [ ] No duplicate URLs in sitemap
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Sitemap covers all indexable page types (static, location, provider, category, deal, category-state)
- Architecture prepared for future sitemap index scaling
- Code well-organized with clear section comments
</success_criteria>

<output>
After completion, create `.planning/phases/30-dynamic-sitemap/30-01-SUMMARY.md`:

# Phase 30-01: Dynamic Sitemap Summary

**[One-liner describing what was accomplished]**

## Accomplishments

- [Key outcome 1]
- [Key outcome 2]

## Files Created/Modified

- `path/to/file.ts` - Description

## Decisions Made

[Key decisions and rationale, or "None"]

## Issues Encountered

[Problems and resolutions, or "None"]

## Next Phase Readiness

[Ready for Phase 31: Internal Linking]
</output>
